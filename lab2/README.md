# Лабораторная работа №2 - Пишем Dockerfile 

## Цель работы

Познакомиться с плохими и хорошими практиками написания Dockerfile.

## Выполение работы

### Пример плохого Dockerfile

Некий студентус написал свой первый Dockerfile:

```
FROM ubuntu:latest

RUN rm /etc/nginx/conf.d/*
ADD helloworld.conf /etc/nginx/conf.d/
ADD index.html /usr/share/nginx/html/

RUN apk update 
RUN apk upgrade
RUN apk add ssh

CMD ["nginx", "-g", "daemon off;"]
```

### Разбор плохого Dockerfile
Дайте посмотрим на него внимательно и разберёмся, что же тут не так и как можно это всё исправить.

1. **Использован базовый образ операционной системы *ubuntu***.
Поверьте, вам не нужен образ с полноценной ОС, в котором содержится куча ненужного вам ПО, из-за чего раздувается объём контейнера и количество вероятных уязвимостей.
Чем больше образ, тем больше он занимает места на хосте и в registry, а так же растет нагрузка на сеть.
А ёще вам самим придётся доставлять ручками необходимое ПО и интсрументы. Оно вам надо? Вместо этого идём на [докерхаб](https://hub.docker.com/) и выбираем уже готовый образ с нужным нам ПО и минимум мусора.
Например, нам нужен nginx, значит инструкция будет выглядеть так: `FROM nginx:latest`

2. **Использован тэг *latest***.
Использование тэга latest приводит к непредсказуемым последствиям.
Допустим, в ваш репозиторий добавлили новую версию образа с другим списком ПО и обновлениями.
Этот образ получает тэг latest.
И ваш контейнер "внезапно" перестает собираться, а в худшем случае вы ловите баги, которых ранее не было. И тратите на это уйму времени.
Если вы не хотите таких приключений, то лучше использвать фиксированную версию образа. Тогда 
В итоге, финальный вид нашей инструкции будет таким: `FROM nginx:1.27.2-alpine`
 
3. **Использование команды *upgrade***.
Возможно, самый распространенный антишаблон. 
Вам не следует использозо apt upgrade внутри ваших контейнеров.
Иначе ваши контейнеры будут отличаться от образа, из которого они были созданы. Что может повлечь за собой различные баги.
Если вы непременно хотите обновить пакеты и их зависимости, то вам следуте собрать новый образ контейнера с новым тэгом.
Так что команду с `upgrade` мы удаляем из нашего Dockerfile.

4. **Отсутствует очистка кеша**.
Инструкция `RUN apk update` прихранит индекс в кэше, что увеличит размер образа.
Лучшим решением будет объединить использовать опцию `--no-cache` при установке нудного пакета.
Хотя с другой стороны, а зачем вам вообще ssh в контейнере? Удалить нафиг!

### Корректный Dockerfile

В итоге получили исправленный Dockerfile:

```
FROM nginx:1.27.2-alpine

RUN rm /etc/nginx/conf.d/*
ADD helloworld.conf /etc/nginx/conf.d/
ADD index.html /usr/share/nginx/html/

CMD ["nginx", "-g", "daemon off;"]
```

Мы молодцы, мы красавчики.

### Плохие практики при работе с контейнерами:

1. **Работа с контейнерами как с вирутальными машинами**.
Важно осознать, что контейнер - это не виртуальная машина!
После запуска контейнера ты не должен лезть внутрь него.
Если ручки так и чешутся подключиться по ssh к контейнеру, что что-то там обновиться или выкачать логи - то ты явно не понял, как правильно работать с контейнерами и что они такое.


2. **Создание Dockerfiles, которые как то влияют на внешнее окружение**. 
Dockerfile - это вам не баш-скрипт! Он должен собрать собраз и не более. Никаких записей в бд, никаких коммитов, никаких изменений данных вне контейнера.
Dockerfile должен упаковать приложение и всё. А вот уже само приложение пусть хоть обпишется в бд.
Чек-лист того, что можно делать в Dockerfile:
- клонирование исходного кода
- скачивание зависимостей
- компиляция или упаковка исходного кода
- обработка-минимизация-преобразование локальных ресурсов
- запуск скриптов и редактирование файлов, лежащих только в файловой системе контейнера.

## В заключение

При написании Dockerfile очень легко облажаться на ровном месте, поэтому надо знать все Best Practies как отче наш.
